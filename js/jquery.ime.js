!function(t){"use strict";function e(t){t["static"]=t["static"]||{}}function n(e,n){e.parent=n,e.prototype=t.extend({},n.prototype),e.prototype.constructor=n.constructor,e["static"]=t.extend({},n["static"])}function i(e,n,i){this.$element=t(e),this.textEntry=n,t.ime.defaults.languages=s(t.ime.languages),this.options=t.extend({},t.ime.defaults,i),this.options.imePath&&(t.ime.path=this.options.imePath),this.active=!1,this.shifted=!1,this.inputmethod=null,this.language=null,this.context="",this.options.showSelector&&(this.selector=this.$element.imeselector(this.options)),this.listen()}function o(t){window.console&&window.console.log&&window.console.log(t)}function s(e){return t.map(e,function(t,e){return e})}var r,a,c,u,l;i.prototype={constructor:i,listen:function(){this.$element.on("keypress.ime",t.proxy(this.keypress,this)),this.$element.on("keyup.ime",t.proxy(this.keyup,this)),this.$element.on("keydown.ime",t.proxy(this.keydown,this)),this.$element.on("destroy.ime",t.proxy(this.destroy,this)),this.$element.on("enable.ime",t.proxy(this.enable,this)),this.$element.on("disable.ime",t.proxy(this.disable,this))},getLanguageCodes:function(){return t.ime.defaults.languages},getAutonym:function(e){return t.ime.languages[e].autonym},getInputMethodIds:function(e){return t.ime.languages[e].inputmethods},getInputMethodName:function(e){return t.ime.sources[e].name},getInputMethods:function(e){return this.getInputMethodIds(e).map(function(e){return{id:e,name:t.ime.sources[e].name}})},transliterate:function(e,n,i){var o,s,r,a,c,u;if(o=i?this.inputmethod.patterns_x||[]:this.inputmethod.patterns||[],this.shifted&&(o=(this.inputmethod.patterns_shift||[]).concat(o)),t.isFunction(o))return u=o.call(this,e,n),"string"==typeof u?{noop:e===u,output:u}:u;for(c=0;c<o.length;c++)if(r=o[c],s=new RegExp(r[0]+"$"),a=r.slice(-1)[0],s.test(e)){if(3!==r.length)return{noop:!1,output:e.replace(s,a)};if(new RegExp(r[1]+"$").test(n))return{noop:!1,output:e.replace(s,a)}}return{noop:!0,output:e}},keyup:function(t){16===t.which&&(this.shifted=!1)},keydown:function(t){16===t.which&&(this.shifted=!0)},keypress:function(t){var e,n,i,o=!1;return this.active&&this.inputmethod?8===t.which?(this.context="",!0):((t.altKey||t.altGraphKey)&&(o=!0),t.which<32&&13!==t.which&&!o||t.ctrlKey||t.metaKey?(this.context="",!0):(e=String.fromCharCode(t.which),n=this.textEntry.getTextBeforeSelection(this.inputmethod.maxKeyLength),i=this.transliterate(n+e,this.context,o),this.context+=e,this.context.length>this.inputmethod.contextLength&&(this.context=this.context.substring(this.context.length-this.inputmethod.contextLength)),i.noop?!0:(this.textEntry.replaceTextAtSelection(n.length,i.output),t.stopPropagation(),!1))):!0},isActive:function(){return this.active},disable:function(){this.active=!1,t.ime.preferences.setIM("system")},enable:function(){this.active=!0},toggle:function(){this.active=!this.active},destroy:function(){t("body").off(".ime"),this.$element.off(".ime").removeData("ime").removeData("imeselector")},getIM:function(){return this.inputmethod},setIM:function(e){this.inputmethod=t.ime.inputmethods[e],t.ime.preferences.setIM(e),this.$element.trigger("imeMethodChange")},setLanguage:function(e){return t.ime.languages[e]?(this.language=e,t.ime.preferences.setLanguage(e),this.$element.trigger("imeLanguageChange"),!0):(o("Language "+e+" is not known to jquery.ime."),!1)},getLanguage:function(){return this.language},load:function(e){return t.ime.load(e)}},r=function(){this.TextEntryClasses=[]},e(r),r.prototype.register=function(t){this.TextEntryClasses.unshift(t)},r.prototype.wrap=function(t){var e,n,i;for(e=0,n=this.TextEntryClasses.length;n>e;e++)if(i=this.TextEntryClasses[e],i["static"].canWrap(t))return new i(t)},r["static"].singleton=new r,a=function(){},e(a),a["static"].canWrap=function(){return!1},a.prototype.getTextBeforeSelection=null,a.prototype.replaceTextAtSelection=null,c=function(t){this.$element=t},n(c,a),c["static"].canWrap=function(t){return t.is("input:not([type]), input[type=text], input[type=search], textarea")&&!t.prop("readonly")&&!t.prop("disabled")&&!t.hasClass("noime")},c.prototype.getTextBeforeSelection=function(t){var e=this.getCaretPosition();return this.$element.val().substring(Math.max(0,e.start-t),e.start)},c.prototype.replaceTextAtSelection=function(t,e){var n,i,o,s,r,a,c=this.$element.get(0);"number"==typeof c.selectionStart&&"number"==typeof c.selectionEnd?(s=c.selectionStart,r=c.scrollTop,c.value=c.value.substring(0,s-t)+e+c.value.substring(c.selectionEnd,c.value.length),c.scrollTop=r,c.selectionStart=c.selectionEnd=s-t+e.length):(a=this.getCaretPosition(),n=c.createTextRange(),i=c.value.length,o=c.value.match(/\n/g),o&&(i-=o.length),n.moveStart("character",a.start-t),n.moveEnd("character",a.end-i),n.text=e,n.collapse(!1),n.select())},c.prototype.getCaretPosition=function(){var t,e,n,i,o,s,r=this.$element.get(0),a=0,c=0;return"number"==typeof r.selectionStart&&"number"==typeof r.selectionEnd?(a=r.selectionStart,c=r.selectionEnd):(e=document.selection.createRange(),e&&e.parentElement()===r&&(i=r.value.length,t=r.value.replace(/\r\n/g,"\n"),o=t.match(/\n/g),n=r.createTextRange(),n.moveToBookmark(e.getBookmark()),s=r.createTextRange(),s.collapse(!1),n.compareEndPoints("StartToEnd",s)>-1?a=c=o?i-o.length:i:(a=-n.moveStart("character",-i),c=n.compareEndPoints("EndToEnd",s)>-1?i:-n.moveEnd("character",-i)))),{start:a,end:c}},r["static"].singleton.register(c),u=function(t){this.$element=t},n(u,a),u["static"].canWrap=function(t){return t.is("[contenteditable]")&&!t.hasClass("noime")},u.prototype.getTextBeforeSelection=function(t){var e=this.getSelectedRange();return e&&e.collapsed&&e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.nodeValue.substring(Math.max(0,e.startOffset-t),e.startOffset):""},u.prototype.replaceTextAtSelection=function(t,e){var n,i,o,s,r;this.getSelectedRange()&&(this.$element.trigger("compositionstart"),n=this.getSelectedRange(),n.collapsed||n.deleteContents(),n.startContainer.nodeType===Node.TEXT_NODE?(i=n.startContainer,o=n.startOffset,i.nodeValue=i.nodeValue.substr(0,o-t)+e+i.nodeValue.substr(o),s=o-t+e.length,r=rangy.createRange(),r.setStart(n.startContainer,s),r.setEnd(n.startContainer,s),rangy.getSelection().setSingleRange(r)):(i=document.createTextNode(e),n.startContainer.insertBefore(i,n.startContainer.childNodes[n.startOffset]),r=rangy.createRange(),r.setStart(i,i.length),r.setEnd(i,i.length),rangy.getSelection().setSingleRange(r)),this.$element.trigger("compositionend"),this.$element.trigger("input"))},u.prototype.getSelectedRange=function(){var t,e;return rangy.init(),t=rangy.getSelection(),0===t.rangeCount?null:(e=t.getRangeAt(0),this.$element[0].contains(e.commonAncestorContainer)?e:null)},r["static"].singleton.register(u),t.fn.ime=function(e){return this.each(function(){var n,o,s=t(this),a="object"==typeof e&&e;if(n=s.data("ime"),!n){if(o=r["static"].singleton.wrap(s),void 0===o)return;n=new i(this,o,a),s.data("ime",n)}"string"==typeof e&&n[e]()})},t.ime={},t.ime.inputmethods={},t.ime.sources={},t.ime.preferences={},t.ime.languages={},t.ime.path="../",t.ime.textEntryFactory=r["static"].singleton,t.ime.TextEntry=a,t.ime.inheritClass=n,l={contextLength:0,maxKeyLength:1},t.ime.load=function(e){var n,i=t.Deferred();return t.ime.inputmethods[e]?i.resolve():t.ime.sources[e]?(n=t.ime.sources[e].depends,n&&!t.ime.inputmethods[n]?(t.ime.load(n).done(function(){t.ime.load(e).done(function(){i.resolve()})}),i):(o("Loading "+e),i=t.ajax({url:t.ime.path+t.ime.sources[e].source,dataType:"script",cache:!0}).done(function(){o(e+" loaded")}).fail(function(t,n,i){o("Error in loading inputmethod "+e+" Exception: "+i)}),i.promise())):i.reject()},t.ime.register=function(e){t.ime.inputmethods[e.id]=t.extend({},l,e)},t.ime.setPath=function(e){t.ime.path=e},t.ime.defaults={languages:[],helpHandler:null,showSelector:!0}}(jQuery);
